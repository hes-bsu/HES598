---
title: "Advanced Topic: Landscape Metrics and Raster Data"
author: "Merry M Davidson"
date: "4/6/2020"
output: html_document
---

## Introduction:
My thesis research aims to quantify the degree of change on the landscape and the effects of habitat on the wildlife community. The study site of interest is the Rupununi savanna-forest boundary located on the Southwest portion of Guyana (South America). To quantify change, I used Landsat derived satellite images to generate rasters using Spectral Unmixing Analysis classification (from this point on-SUA). This classification identifies the fractional component for each pixel based on user-generated classes or end members. For my SUA, I used the following classes: forest, bare ground, grass, and water.
My chosen Advanced Topic for this course is Landscape Metrics and Raster Data. 
My goal for this assignment is to learn and practice using raster data in R with the following raster packages: raster, rgdal, and rgeos. Specifically, I will obtain SUA pixel values of 13 specific points in a subset of my study area.  
The bigger picture: This information will be used in a generalized linear model that will look at wildlife-landscape interactions.

For more information on Google Earth Engine Spectral Unmixing Classification: https://developers.google.com/earth-engine/image_transforms
For more background on applying Spectral Unmixing Classification:
https://www.sciencedirect.com/science/article/abs/pii/S0034425718305200



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


## PSUEDOCODE:
My plan or outline

```{r}
#load the libraries - 
#library(googledrive) #for loading in the data
#library(curl) #called for Google Drive data access
#library(here) #called for Google Drive data access (be sure to make a temp folder for downloads)
#library(raster) #to load and augment rasters
#library(rgdal) #to load and augment spatial shape files
#library(rgeos) #to use gbuffer function

#load your data - what data do you need?
##The SUA classification of year 2015 "SUADAD15" (in a UTM coordinate raster file)
#SUADAD15 <- raster()
##GPS points to get SUA totals for "DADPTS" (in a UTM shapefile format)
#DADPTS <- readOGR()

#Organize the data - what form should the data be in? 
##The final goal is to end up with 2 rasters. This way I can merge the spatial points raster and SUA values raster together. I start off with a raster and a spatial data file of points. 

#Analysis/processing step 1 - what are you hoping to do here, why? 
#To get two raster files, I need to transform my GPS points into a raster so I can merge (stack) both rasters together.
#That is the first step. 

#Analysis/processing step 2 - what are you hoping to do here, why? 
#The second step is to analyze the data. Are there differences in SUA values between the points? 9 out of the 13 points are classified as bush island habitats. Is there more resolution or variability using SUA values instead of the categorical habitat description?

#Check the outcomes- how will you know if your steps worked?
#If I have an SUA value for 13 points, I will know I did it correctly.

```

## Introduce the packages
The critical step in my objective is the transformation from a shapefile into a raster file. 
The three packages that I will use to achieve this objective are: "raster"  "rgdal" and "rgeos"
Raster: https://cran.r-project.org/web/packages/raster/raster.pdf
This package is beneficial to do lots of manipulations to rasters and calculate information within the rasters (such as NDVI or other classification indices). There are several functions from this package that I will use to complete my objective. In order, the functions and uses are as follows: mask() was used to visually see the SUA layer on the specified GPS points. rasterize() function transformed the GPS shapefile into a raster. stack() function put the 2 layers in alignment to extract the SUA values from the specific points. Lastly, aggregate() function made a table with the SUA values by site!

Rgdal: https://cran.r-project.org/web/packages/rgdal/rgdal.pdf
The rgdal package is useful for working with vectors, also known as shapefiles. Although there are some functions work for rasters as well, I will only use this package to read in the GPS shapefile using the readOGR() function.

Rgeos: https://cran.rstudio.com/web/packages/rgeos/rgeos.pdf
I used the rgeos package for the gBuffer() function. This is the step where I turned my 13 points of interest into 100 m buffer points to later get SUA values for that area.




#Actual code:
Load the libraries
```{r}
library(googledrive) #for loading in the data
library(curl) #called for Google Drive data access
library(here) #called for Google Drive data access (be sure to make a temp folder for downloads)
library(raster) #to load and augment rasters
library(rgdal) #to load and augment spatial shape files
library(rgeos) #to use gBuffer function
```


```{r include=FALSE}
#for loading in the data


#library(googledrive) #for loading in the data
#authenticating google drive
options(
  gargle_oauth_cache = ".merrymd",
  gargle_oauth_email = TRUE
)


#library(curl) #called for Google Drive data access
#library(here) #called for Google Drive data access (be srue to make a temp folder for downloads)


folder_url <- "https://drive.google.com/open?id=1Co7q8ggqr1CjbdUcbN0-9LtnHygshKkq"

folder <- drive_get(as_id(folder_url))

files <- drive_ls(folder)

lapply(files$id, function(x) drive_download(as_id(x), path = paste0(here::here("datatemp/original/"), files[files$id==x,]$name), overwrite = TRUE))


```

#GPS Points
```{r}
#load in points (UTM transformed points in a shapefile)
DADPTS <- readOGR("C:/Users/Nessa/Courses/HES598/datatemp/originalUTMzone21N.shp")
str(DADPTS)#check the data
plot(DADPTS)
```

#SUA Year 2015 raster 

```{r}
#library(rgdal)
#library("raster") #to load rasters
#load in SUA Year 2015 raster
SUADAD15 <- raster("C:/Users/Nessa/Courses/HES598/datatemp/originalYear2015_UTMzone21N.tif")
plot(SUADAD15)
```


#Make 100m buffers around the points

```{r}
#library("rgdal")
#library("rgeos")
#library("sp")
#library("raster")

#library("rgeos")#for the buffer function, gBuffer(); ###rgdal workded also..
buffDADPTS <- gBuffer(DADPTS,byid=T,width=100) #width is in meter
plot(buffDADPTS)#visually check
```

#Combine Geometry Points with SUA raster data
```{r}

#library(sp)
#library(rgdal)


mskbuffDADPTS <- mask(x=SUADAD15,mask=buffDADPTS)#mask function to reduce the raster to buffer object
plot(mskbuffDADPTS)

```

##Add points to buffer data frame
```{r}
head(buffDADPTS@data)
#add a Point ID to buffer raster
buffDADPTS@data$ID<-as.numeric(buffDADPTS@data$Trap.Site)
head(buffDADPTS@data)
```

## Rasterize buffer layer 
```{r}

#rasterize()turns buffer layer shapefile into raster
trap_id_raster<-rasterize(x=buffDADPTS,y=SUADAD15,field="ID")  
trap_id_raster

```

## Stack the 2 rasters and data
```{r}
#stack the rasters
PTSUA_raster <- stack(x=trap_id_raster,y=SUADAD15)
PTSUA_raster
#stack the data
stack_dat<-rasterToPoints(PTSUA_raster)
head(stack_dat)
```

##Lastly (final product), get SUA values for each point
```{r}
agg_sua_camera_trap<-aggregate(stack_dat,by=list("cam_trap_ID"=stack_dat[,3]),FUN=mean,na.rm=T)
agg_sua_camera_trap
```

##Lastly (final product), get stadard deviation of SUA values for each point
```{r}
sd.agg_sua_camera_trap<-aggregate(stack_dat,by=list("cam_trap_ID"=stack_dat[,3]),FUN=sd,na.rm=T)
sd.agg_sua_camera_trap
```


##Conclusion
To refer back to the pseudocode, I would know if was successful in my objective if I had an SUA value for 13 points. Indeed, that is what I have!!
The objectives I asked were: Is there more resolution or variability using SUA values instead of the catergorical habitat description?
Conclusion: There IS more variability when looking at the SUA values compared to a categorical habitat variable.

The next step then is to include the SUA values in a model that looks at effects of the points on species. I will also obtain SUA values for more points within my study area so increase sample size in the model.

## Reflect
This was very helpful in making progress with my thesis! I got more practice coding and working with rasters in R.

