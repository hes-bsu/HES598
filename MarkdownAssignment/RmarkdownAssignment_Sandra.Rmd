---
title: "RMarkdown Assignment"
author: "Sandra Velazco"
date: "2/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sp)
library(raster)
library(rgdal)
library(sf)
library(lattice)
library(rasterVis)

```

## Introduction of my research

One of my thesis objectives is to evaluate the effect of size and shape of bracken fern-dominated patches in the plants recruitment (using NDVI index), and to determine the temporal influence of land-use change in the expansion of bracken fern in the Cloud Mountain forest.

Question 1: How do the forest distance and shape of bracken fern influence the establishment of native plants in degraded montane areas?

Question 2: How do the land-use change influence the spatial and temporal pattern of bracken fern?


Why is it important?:
My research research will unite ecological field data on forest succession and remotely sensed data on land cover change to quantify recovery after fern invasion in northern Peru. The recovery of these degraded areas is crucial to restore local wildlife and the ecological services that they provide, to diminish the effect of fragmented landscape, and to increase carbon storage. 

What role does spatial data play in my research questions?
Spatial data allow me to obtain a vegetation index (NDVI) from pixels belong to each polygon of my study area. For this purpose, I am using satellite imagery from Google Earth Engine. Then, to extract elevation data using a digital elevation model and to measure the distance of each pixel (in each polygon) to the forest. Finally, to classify land cover types to distinguish bracken fern from other cover types.

## Study Area

The Tropical Cloud Mountain Forest in the north of Peru faces constant anthropogenic pressure due to agriculture expansion, cattle grazing, and timber harvesting, activities that have increased open areas, and forest fragmentation in this region. My study area  is characterized by a landscape of matrix of agricultural systems, continuous forest, remnants of fragmented forests, and degraded lands. Bracken fern "Pteridium esculentum", registered in the Andes, usually dominates degraded lands from the lower to the middle slopes of mountains (< 2000 meters), in abandoned agricultural and grazing areas that farmers burn generally.

## Upload files

```{r studyarea}
# Map of my study area
studyarea <- st_read("./studyarea_shape.shp")

## Polygonss of my studyarea
polygons <- st_read("./polytabac_merge.shp")

## Raster file to calculate NDVI
planet<-raster::stack("./tabaconas_raster.tif")

## Raster file of elevation
elev=raster::raster("./raster.tif")

```

## Processing files

```{r}
# check projections
st_crs(polygons)
st_crs(studyarea)
proj4string(planet)
proj4string(elev)
# They do not match, we need to reproject polygons and elev files using CRS information of planet raster.
proj <- crs(elev)
# CRS: "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
planet_new<-raster::projectRaster(planet, crs = proj)
polygons_new <- st_transform(polygons, crs=proj)
# Transform polygons into spatialpolygons
polygons_sp <- sf:::as_Spatial(polygons_new$geom)

```

## Mapping attributes of my data

```{r attributeplot}

# Calculate NDVI for my study area
NIR<-(planet_new[[4]]-planet_new[[1]])/(planet_new[[4]]+planet_new[[1]])
# Stack NDVI band in planet image
planetNDVI<-raster::stack(planet_new,NIR)
writeRaster(planetNDVI,file="planetNDVI.tif",format="GTiff",overwrite=TRUE)
# Plot polygons over NDVI map
plot(NIR)
plot(polygons_sp, cex = 0.5, add=TRUE)
# Plot polygons over elevation map
myCol <- terrain.colors(6)
plot(elev, col=myCol)
plot(polygons_sp, cex = 0.5, add=TRUE)
# Retrieve precipitation data from WorldClim
global.precip <- getData('worldclim', download=TRUE, var='prec', res=2.5)
# Lets use precipitation in January as an example (units are in mm)
plot(global.precip$prec11, main="November Precipitation")
# Resize the global precipitation raster to my study area
precip_mask <- raster::crop(global.precip$prec11, studyarea, snap="near")
plot(studyarea)
plot(precip_mask)
# Mask the global precipitation rasters to my study area raster
stmask <- mask(precip_mask, studyarea)
# Plot
plot(stmask)

```

## Plot maps

```{r}

## Plot polygons over elevation map
myCol <- terrain.colors(6)
plot(elev, xlab="Lat", ylab="Long", col=myCol)
plot(polygons_sp, cex = 0.5, add=TRUE)

levelplot(elev, 
          margin=FALSE,                       
          colorkey=list(
            space='bottom',                   
            labels=list(at=-5:5, font=4)      
          ),    
          par.settings=list(
            axis.line=list(col='transparent')
          )) +           
  layer(sp.polygons(polygons_sp, lwd=3))   

```

## What did you learn?

The use of spatial analysis to plot dataset offer more advantage that the traditional use of Gis programs. It is possible to change the background of the map, improving the color by using different resources for color palette (e.g., terrain, colors, RColorBrewer). Finally, the aesthetic function allows modifying many parameters of maps, as we noticed in the comparison of both plots. In the examples, the plots are not the final product because they need to be resized for improving the visualization of bracken fern polygons. Likewise, both require names in the color scale of the legend.